<!DOCTYPE html><html lang="ja">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>多项目倒数计时器</title>
  <style>
    body {
      margin: 0;
      font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, Helvetica, Arial, sans-serif;
      background: #f2f2f7;
      color: #1c1c1e;
    }
    .container {
      max-width: 600px;
      margin: auto;
      padding: 1em;
    }
    h1 {
      text-align: center;
      font-size: 1.4em;
      margin-bottom: 1em;
      color: #007aff;
    }
    .add-area {
      display: flex;
      flex-wrap: wrap;
      gap: 0.5em;
      margin-bottom: 1em;
    }
    .add-area input {
      flex: 1;
      padding: 0.6em;
      border-radius: 10px;
      border: 1px solid #ccc;
      font-size: 1em;
    }
    .add-area button {
      width: 100%;
      padding: 0.8em;
      font-size: 1em;
      border: none;
      border-radius: 10px;
      background-color: #007aff;
      color: white;
      cursor: pointer;
    }
    .project {
      background: white;
      border-radius: 16px;
      box-shadow: 0 4px 8px rgba(0,0,0,0.05);
      padding: 1em;
      margin-bottom: 1em;
      position: relative;
    }
    .project h2 {
      margin-top: 0;
      margin-bottom: 0.6em;
      font-size: 1.2em;
    }
    .sort-up, .sort-down {
      position: absolute;
      top: 1em;
      background: transparent;
      color: #007aff;
      border: none;
      font-size: 1.2em;
      cursor: pointer;
    }
    .sort-up { right: 3em; }
    .sort-down { right: 1em; }
    .progress-container {
      position: relative;
      background: #e5e5ea;
      border-radius: 12px;
      overflow: hidden;
      height: 20px;
      margin: 0.5em 0;
    }
    .progress-fill {
      height: 100%;
      background: #007aff;
      color: white;
      text-align: center;
      line-height: 20px;
      font-weight: bold;
      white-space: nowrap;
      transition: width 0.3s;
    }
    .progress-over {
      position: absolute;
      top: 0;
      left: 100%;
      height: 100%;
      background: #ff3b30;
      color: white;
      text-align: center;
      line-height: 20px;
      font-weight: bold;
      white-space: nowrap;
      padding-left: 5px;
    }
    .info {
      font-size: 0.9em;
      margin-bottom: 0.5em;
      color: #555;
    }
    .actions {
      display: flex;
      gap: 0.6em;
      margin-bottom: 0.6em;
    }
    .actions input {
      flex: 1;
      padding: 0.5em;
      font-size: 0.9em;
      border-radius: 8px;
      border: 1px solid #ccc;
    }
    .actions .record-btn {
      flex: 1.5;
      background: #28a745;
      color: white;
      border: none;
      border-radius: 8px;
      font-size: 1.1em;
      padding: 0.6em 1em;
      cursor: pointer;
    }
    .func-buttons {
      display: flex;
      flex-wrap: wrap;
      gap: 0.5em;
    }
    .func-buttons button {
      flex: 1;
      padding: 0.6em;
      font-size: 0.9em;
      border: none;
      border-radius: 8px;
      color: white;
      cursor: pointer;
    }
    .undo-btn { background: #ccc; color: black; }
    .reset-btn, .rename-btn { background: #f0ad4e; }
    .change-total-btn { background: #007aff; }
    .del-btn { background: #d9534f; }
    .global-reset {
      width: 100%;
      padding: 0.8em;
      border: none;
      border-radius: 12px;
      background: #d9534f;
      color: white;
      font-size: 1em;
      margin-top: 1em;
    }
    .night-mode-btn {
      position: fixed;
      top: 1em;
      right: 1em;
      background: #444;
      color: white;
      border: none;
      border-radius: 10px;
      padding: 0.5em 0.8em;
      font-size: 0.9em;
      cursor: pointer;
      z-index: 10;
    }
    .night-mode {
      background: #1c1c1e;
      color: white;
    }
    .night-mode .project {
      background: #2c2c2e;
    }
    .night-mode .progress-container {
      background: #3a3a3c;
    }
    .night-mode .progress-fill {
      background: #0a84ff;
    }
    .night-mode .progress-over {
      background: #ff453a;
    }
  </style>
</head>
<body id="body">
  <div class="container">
    <h1>多项目倒数计时器</h1>
    <div class="add-area">
      <input id="newName" placeholder="项目名称" />
      <input id="newTotal" type="number" placeholder="总时间（分钟）" />
      <button onclick="addProject()">添加项目</button>
    </div>
    <div id="projectList"></div>
    <button class="global-reset" onclick="resetAll()">重置所有项目</button>
    <button class="night-mode-btn" onclick="toggleNightMode()">切换夜间模式</button>
  </div>
  <script>
    const STORAGE_KEY = 'multiCountdownProjects', NIGHT_MODE_KEY = 'nightModeEnabled';
    let projects = JSON.parse(localStorage.getItem(STORAGE_KEY)) || [], nightMode = JSON.parse(localStorage.getItem(NIGHT_MODE_KEY)) || false;
    function save() { localStorage.setItem(STORAGE_KEY, JSON.stringify(projects)); }
    function saveNightMode() { localStorage.setItem(NIGHT_MODE_KEY, JSON.stringify(nightMode)); }
    function addProject() {
      const name = document.getElementById('newName').value.trim(), total = parseInt(document.getElementById('newTotal').value, 10);
      if (!name || isNaN(total) || total <= 0) return;
      projects.push({ name, total, used: 0, lastAddedTime: 0 });
      save(); render();
      document.getElementById('newName').value = '';
      document.getElementById('newTotal').value = '';
    }
    function recordTime(i) {
      const m = +document.getElementById('add' + i).value;
      if (!m) return;
      projects[i].lastAddedTime = m;
      projects[i].used = projects[i].used + m;
      save(); render();
    }
    function undoLast(i) {
      projects[i].used = Math.max(0, projects[i].used - projects[i].lastAddedTime);
      projects[i].lastAddedTime = 0;
      save(); render();
    }
    function resetProject(i) {
      if (!confirm(`重置 "${projects[i].name}"？`)) return;
      projects[i].used = 0;
      save(); render();
    }
    function deleteProject(i) {
      if (!confirm(`删除 "${projects[i].name}"？`)) return;
      projects.splice(i, 1);
      save(); render();
    }
    function renameProject(i) {
      const n = prompt('新名称：', projects[i].name);
      if (n) { projects[i].name = n; save(); render(); }
    }
    function changeTotal(i) {
      const t = parseInt(prompt('新总时间（分钟）：', projects[i].total), 10);
      if (!isNaN(t) && t > 0) {
        projects[i].total = t;
        if (projects[i].used > t) projects[i].used = t;
        save(); render();
      }
    }
    function moveProject(i, d) {
      const t = i + d;
      if (t < 0 || t >= projects.length) return;
      [projects[i], projects[t]] = [projects[t], projects[i]];
      save(); render();
    }
    function resetAll() {
      if (!confirm('重置所有项目？')) return;
      projects.forEach(p => p.used = 0);
      save(); render();
    }
    function toggleNightMode() {
      nightMode = !nightMode;
      saveNightMode();
      document.body.classList.toggle('night-mode', nightMode);
    }
    function render() {
      document.body.classList.toggle('night-mode', nightMode);
      const list = document.getElementById('projectList');
      list.innerHTML = '';
      projects.forEach((p, i) => {
        const r = p.total - p.used;
        const pct = (p.used / p.total) * 100;
        const cappedPct = Math.min(pct, 100);
        const overPct = pct > 100 ? pct - 100 : 0;
        const d = document.createElement('div');
        d.className = 'project';
        d.innerHTML = `
          <h2>${p.name}</h2>
          <div class="info">已用：${p.used} 分钟 / 总计：${p.total} 分钟（剩余：${Math.max(0, r)} 分钟）</div>
          <div class="progress-container">
            <div class="progress-fill" style="width: ${cappedPct}%; z-index:1;">${Math.floor(pct)}%</div>
            ${overPct > 0 ? `<div class="progress-over" style="width: ${overPct}%">+${Math.floor(overPct)}%</div>` : ''}
          </div>
          <div class="actions">
            <input id="add${i}" type="number" placeholder="追加分钟数" />
            <button class="record-btn" onclick="recordTime(${i})">记录</button>
          </div>
          <div class="func-buttons">
            <button class="undo-btn" onclick="undoLast(${i})">撤销</button>
            <button class="reset-btn" onclick="resetProject(${i})">重置</button>
            <button class="rename-btn" onclick="renameProject(${i})">改名</button>
            <button class="change-total-btn" onclick="changeTotal(${i})">改总数</button>
            <button class="del-btn" onclick="deleteProject(${i})">删除</button>
            <button class="sort-up" onclick="moveProject(${i}, -1)">↑</button>
            <button class="sort-down" onclick="moveProject(${i}, 1)">↓</button>
          </div>
        `;
        list.appendChild(d);
      });
    }
    render();
  </script>
</body>
</html>
